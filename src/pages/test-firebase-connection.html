<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Conexi√≥n Firebase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-box {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-box h2 {
      margin-top: 0;
      color: #1976d2;
    }
    .result {
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    .info {
      background: #e3f2fd;
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }
    button {
      padding: 12px 24px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #1565c0;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1976d2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>üîç Test de Conexi√≥n a Firebase</h1>
  
  <div class="test-box">
    <h2>1. Test de Conexi√≥n B√°sica</h2>
    <button onclick="testBasicConnection()">üåê Probar Conexi√≥n</button>
    <div id="basicResult"></div>
  </div>

  <div class="test-box">
    <h2>2. Test de Mensajes</h2>
    <button onclick="testMessages()">üí¨ Verificar Mensajes</button>
    <div id="messagesResult"></div>
  </div>

  <div class="test-box">
    <h2>3. Test de Usuarios</h2>
    <button onclick="testUsers()">üë• Verificar Usuarios</button>
    <div id="usersResult"></div>
  </div>

  <div class="test-box">
    <h2>4. Test de Usuario Actual</h2>
    <button onclick="testCurrentUser()">üë§ Verificar Sesi√≥n</button>
    <div id="currentUserResult"></div>
  </div>

  <div class="test-box">
    <h2>5. Test Completo de Carga de Conversaciones</h2>
    <button onclick="testFullConversations()">üì± Simular Carga de Chats</button>
    <div id="fullTestResult"></div>
  </div>

  <script>
    const FIREBASE_URL = "https://laburitoya-6e55d-default-rtdb.firebaseio.com";

    function showLoading(elementId) {
      const element = document.getElementById(elementId);
      element.innerHTML = '<div class="result info">‚è≥ Cargando...<span class="loading"></span></div>';
    }

    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="result ${type}">${message}</div>`;
    }

    async function testBasicConnection() {
      showLoading('basicResult');
      try {
        console.log('üåê Probando conexi√≥n b√°sica a Firebase...');
        const response = await fetch(`${FIREBASE_URL}/.json`);
        
        if (response.ok) {
          const data = await response.json();
          showResult('basicResult', 
            `‚úÖ Conexi√≥n exitosa!\n\nStatus: ${response.status}\nDatos recibidos: ${data ? 'S√≠' : 'No'}`, 
            'success'
          );
          console.log('‚úÖ Conexi√≥n exitosa:', data);
        } else {
          showResult('basicResult', 
            `‚ùå Error de conexi√≥n\n\nStatus: ${response.status}\nStatusText: ${response.statusText}`, 
            'error'
          );
          console.error('‚ùå Error:', response.status, response.statusText);
        }
      } catch (error) {
        showResult('basicResult', 
          `‚ùå Error: ${error.message}\n\nPosibles causas:\n- Sin conexi√≥n a internet\n- Firebase bloqueado\n- CORS error`, 
          'error'
        );
        console.error('‚ùå Error:', error);
      }
    }

    async function testMessages() {
      showLoading('messagesResult');
      try {
        console.log('üí¨ Verificando mensajes en Firebase...');
        const response = await fetch(`${FIREBASE_URL}/mensajes.json`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data) {
            const count = Object.keys(data).length;
            showResult('messagesResult', 
              `‚úÖ Mensajes encontrados: ${count}\n\nPrimeros IDs:\n${Object.keys(data).slice(0, 5).join('\n')}`, 
              'success'
            );
            console.log('‚úÖ Mensajes:', data);
          } else {
            showResult('messagesResult', 
              `‚ÑπÔ∏è No hay mensajes en la base de datos\n\nEsto es normal si no se han enviado mensajes a√∫n.`, 
              'info'
            );
            console.log('‚ÑπÔ∏è No hay mensajes');
          }
        } else {
          showResult('messagesResult', 
            `‚ùå Error al obtener mensajes\n\nStatus: ${response.status}`, 
            'error'
          );
        }
      } catch (error) {
        showResult('messagesResult', 
          `‚ùå Error: ${error.message}`, 
          'error'
        );
        console.error('‚ùå Error:', error);
      }
    }

    async function testUsers() {
      showLoading('usersResult');
      try {
        console.log('üë• Verificando usuarios en Firebase...');
        const response = await fetch(`${FIREBASE_URL}/usuarios.json`);
        
        if (response.ok) {
          const data = await response.json();
          
          if (data) {
            const count = Object.keys(data).length;
            const usersList = Object.entries(data).slice(0, 5).map(([id, user]) => 
              `- ${user.nombre || 'Sin nombre'} (${user.correo || 'Sin correo'})`
            ).join('\n');
            
            showResult('usersResult', 
              `‚úÖ Usuarios encontrados: ${count}\n\nPrimeros usuarios:\n${usersList}`, 
              'success'
            );
            console.log('‚úÖ Usuarios:', data);
          } else {
            showResult('usersResult', 
              `‚ùå No hay usuarios en la base de datos\n\nEsto es un problema cr√≠tico.`, 
              'error'
            );
            console.log('‚ùå No hay usuarios');
          }
        } else {
          showResult('usersResult', 
            `‚ùå Error al obtener usuarios\n\nStatus: ${response.status}`, 
            'error'
          );
        }
      } catch (error) {
        showResult('usersResult', 
          `‚ùå Error: ${error.message}`, 
          'error'
        );
        console.error('‚ùå Error:', error);
      }
    }

    async function testCurrentUser() {
      showLoading('currentUserResult');
      try {
        console.log('üë§ Verificando usuario actual...');
        const currentUser = localStorage.getItem('usuarioActual');
        
        if (!currentUser) {
          showResult('currentUserResult', 
            `‚ùå No hay usuario en sesi√≥n\n\nDebes iniciar sesi√≥n primero en login.html`, 
            'error'
          );
          return;
        }

        const user = JSON.parse(currentUser);
        
        // Verificar que el usuario existe en Firebase
        const response = await fetch(`${FIREBASE_URL}/usuarios/${user.id}.json`);
        
        if (response.ok) {
          const userData = await response.json();
          
          if (userData) {
            showResult('currentUserResult', 
              `‚úÖ Usuario autenticado correctamente\n\nID: ${user.id}\nNombre: ${user.nombre}\nCorreo: ${user.correo}\n\n‚úÖ Usuario existe en Firebase`, 
              'success'
            );
            console.log('‚úÖ Usuario actual:', user);
            console.log('‚úÖ Datos en Firebase:', userData);
          } else {
            showResult('currentUserResult', 
              `‚ö†Ô∏è Usuario en sesi√≥n pero NO existe en Firebase\n\nID: ${user.id}\nNombre: ${user.nombre}\n\nEsto puede causar problemas.`, 
              'error'
            );
          }
        }
      } catch (error) {
        showResult('currentUserResult', 
          `‚ùå Error: ${error.message}`, 
          'error'
        );
        console.error('‚ùå Error:', error);
      }
    }

    async function testFullConversations() {
      showLoading('fullTestResult');
      let log = '';
      
      try {
        log += 'üîÑ Iniciando simulaci√≥n de carga de conversaciones...\n\n';
        
        // 1. Verificar usuario
        log += '1Ô∏è‚É£ Verificando usuario actual...\n';
        const currentUser = localStorage.getItem('usuarioActual');
        
        if (!currentUser) {
          log += '‚ùå ERROR: No hay usuario en sesi√≥n\n';
          showResult('fullTestResult', log, 'error');
          return;
        }
        
        const user = JSON.parse(currentUser);
        log += `‚úÖ Usuario: ${user.nombre} (ID: ${user.id})\n\n`;
        
        // 2. Obtener mensajes
        log += '2Ô∏è‚É£ Obteniendo mensajes de Firebase...\n';
        const response = await fetch(`${FIREBASE_URL}/mensajes.json`);
        
        if (!response.ok) {
          log += `‚ùå ERROR: Status ${response.status}\n`;
          showResult('fullTestResult', log, 'error');
          return;
        }
        
        const data = await response.json();
        
        if (!data) {
          log += '‚ùå No hay mensajes en la base de datos\n';
          log += '‚ÑπÔ∏è Esto es normal si no has enviado mensajes a√∫n\n';
          showResult('fullTestResult', log, 'info');
          return;
        }
        
        log += `‚úÖ Mensajes obtenidos: ${Object.keys(data).length}\n\n`;
        
        // 3. Filtrar conversaciones del usuario
        log += '3Ô∏è‚É£ Filtrando conversaciones del usuario...\n';
        const conversaciones = {};
        
        for (const id in data) {
          const mensaje = data[id];
          
          if (mensaje.de === user.id || mensaje.para === user.id) {
            const otroUsuarioId = mensaje.de === user.id ? mensaje.para : mensaje.de;
            
            if (!conversaciones[otroUsuarioId]) {
              conversaciones[otroUsuarioId] = {
                ultimoMensaje: mensaje,
                mensajes: []
              };
            }
            
            conversaciones[otroUsuarioId].mensajes.push(mensaje);
            
            if (new Date(mensaje.fecha) > new Date(conversaciones[otroUsuarioId].ultimoMensaje.fecha)) {
              conversaciones[otroUsuarioId].ultimoMensaje = mensaje;
            }
          }
        }
        
        const numConversaciones = Object.keys(conversaciones).length;
        log += `‚úÖ Conversaciones encontradas: ${numConversaciones}\n\n`;
        
        if (numConversaciones === 0) {
          log += '‚ùå No tienes conversaciones\n';
          log += '‚ÑπÔ∏è Env√≠a un mensaje desde una publicaci√≥n para crear una conversaci√≥n\n';
          showResult('fullTestResult', log, 'info');
          return;
        }
        
        // 4. Obtener datos de usuarios
        log += '4Ô∏è‚É£ Obteniendo datos de usuarios...\n';
        for (const userId in conversaciones) {
          const userResponse = await fetch(`${FIREBASE_URL}/usuarios/${userId}.json`);
          if (userResponse.ok) {
            const userData = await userResponse.json();
            if (userData) {
              log += `‚úÖ Usuario: ${userData.nombre}\n`;
            } else {
              log += `‚ö†Ô∏è Usuario ${userId} no encontrado\n`;
            }
          }
        }
        
        log += '\n‚úÖ SIMULACI√ìN COMPLETADA EXITOSAMENTE\n';
        log += `\nüìä Resumen:\n`;
        log += `- Mensajes totales: ${Object.keys(data).length}\n`;
        log += `- Tus conversaciones: ${numConversaciones}\n`;
        log += `\n‚úÖ Los chats DEBER√çAN cargarse correctamente`;
        
        showResult('fullTestResult', log, 'success');
        console.log('‚úÖ Simulaci√≥n completada');
        
      } catch (error) {
        log += `\n‚ùå ERROR: ${error.message}\n`;
        log += `\nStack: ${error.stack}`;
        showResult('fullTestResult', log, 'error');
        console.error('‚ùå Error en simulaci√≥n:', error);
      }
    }

    // Auto-ejecutar test b√°sico al cargar
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Test de Firebase cargado');
      testBasicConnection();
    });
  </script>
</body>
</html>
