<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test - Sistema de Anuncios</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .test-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .test-section h2 {
      color: #667eea;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .test-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }

    .test-item:last-child {
      margin-bottom: 0;
    }

    .test-item h3 {
      font-size: 14px;
      color: #333;
      margin-bottom: 8px;
    }

    .test-item p {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }

    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      font-family: 'Courier New', monospace;
    }

    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .console-log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .console-log .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid #667eea;
      padding-left: 10px;
    }

    .console-log .log-error {
      border-left-color: #f44336;
      color: #ff6b6b;
    }

    .console-log .log-success {
      border-left-color: #4caf50;
      color: #81c784;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      color: #1976d2;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .info-box p {
      color: #555;
      font-size: 13px;
      line-height: 1.6;
    }

    .info-box ul {
      margin-top: 10px;
      margin-left: 20px;
    }

    .info-box li {
      color: #555;
      font-size: 13px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test del Sistema de Anuncios</h1>
    <p class="subtitle">Verificaci√≥n de correcciones implementadas</p>

    <div class="info-box">
      <h3>üìã Instrucciones</h3>
      <p>Este test verifica que las correcciones al sistema de anuncios funcionen correctamente. Aseg√∫rate de:</p>
      <ul>
        <li>Estar autenticado como usuario con permisos de administrador</li>
        <li>Tener el rol de "Gestor de Anuncios" o ser CEO</li>
        <li>Tener conexi√≥n a Firebase</li>
      </ul>
    </div>

    <div class="test-section">
      <h2>
        üîê Verificaci√≥n de Autenticaci√≥n
        <span class="status pending" id="authStatus">Pendiente</span>
      </h2>
      <div class="test-item">
        <h3>Estado de sesi√≥n</h3>
        <p>Verificando si hay un usuario autenticado...</p>
        <div class="test-result" id="authResult" style="display: none;"></div>
      </div>
      <button class="btn" onclick="testAuth()">Verificar Autenticaci√≥n</button>
    </div>

    <div class="test-section">
      <h2>
        üëë Verificaci√≥n de Permisos
        <span class="status pending" id="permissionsStatus">Pendiente</span>
      </h2>
      <div class="test-item">
        <h3>Permisos de creaci√≥n de anuncios</h3>
        <p>Verificando si el usuario tiene permiso para crear anuncios...</p>
        <div class="test-result" id="permissionsResult" style="display: none;"></div>
      </div>
      <button class="btn" onclick="testPermissions()">Verificar Permisos</button>
    </div>

    <div class="test-section">
      <h2>
        ‚úÖ Validaciones de Formulario
        <span class="status pending" id="validationStatus">Pendiente</span>
      </h2>
      <div class="test-item">
        <h3>Test de validaciones</h3>
        <p>Probando las validaciones de campos requeridos y archivos...</p>
        <div class="test-result" id="validationResult" style="display: none;"></div>
      </div>
      <button class="btn" onclick="testValidations()">Probar Validaciones</button>
    </div>

    <div class="test-section">
      <h2>
        üì¢ Creaci√≥n de Anuncio de Prueba
        <span class="status pending" id="createStatus">Pendiente</span>
      </h2>
      <div class="test-item">
        <h3>Crear anuncio de prueba</h3>
        <p>Intenta crear un anuncio de prueba en Firebase...</p>
        <div class="test-result" id="createResult" style="display: none;"></div>
      </div>
      <button class="btn" onclick="testCreateAnnouncement()">Crear Anuncio de Prueba</button>
      <button class="btn btn-secondary" onclick="cleanupTestAnnouncements()">Limpiar Anuncios de Prueba</button>
    </div>

    <div class="test-section">
      <h2>üìä Console Logs</h2>
      <div class="console-log" id="consoleLogs">
        <div class="log-entry">Esperando tests...</div>
      </div>
    </div>

    <div class="test-section">
      <h2>üîó Acciones R√°pidas</h2>
      <button class="btn" onclick="window.location.href='admin-panel.html'">Ir al Panel de Admin</button>
      <button class="btn btn-secondary" onclick="runAllTests()">Ejecutar Todos los Tests</button>
    </div>
  </div>

  <script src="auth.js"></script>
  <script src="roles.js"></script>
  <script>
    let testLogs = [];

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      testLogs.push({ timestamp, message, type });
      updateConsole();
    }

    function updateConsole() {
      const consoleDiv = document.getElementById('consoleLogs');
      consoleDiv.innerHTML = testLogs.map(log => 
        `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
      ).join('');
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    function updateStatus(section, status, message) {
      const statusEl = document.getElementById(`${section}Status`);
      const resultEl = document.getElementById(`${section}Result`);
      
      statusEl.className = `status ${status}`;
      statusEl.textContent = status === 'success' ? 'Exitoso' : status === 'error' ? 'Error' : 'Pendiente';
      
      if (resultEl) {
        resultEl.style.display = 'block';
        resultEl.className = `test-result ${status}`;
        resultEl.textContent = message;
      }
    }

    async function testAuth() {
      addLog('üîê Iniciando test de autenticaci√≥n...', 'info');
      
      try {
        if (!window.auth) {
          throw new Error('M√≥dulo auth no cargado');
        }

        const usuario = auth.obtenerUsuarioActual();
        
        if (!usuario) {
          updateStatus('auth', 'error', '‚ùå No hay usuario autenticado. Por favor inicia sesi√≥n.');
          addLog('‚ùå Test de autenticaci√≥n fallido: No hay sesi√≥n activa', 'error');
          return false;
        }

        const mensaje = `‚úÖ Usuario autenticado: ${usuario.nombre} (${usuario.correo})`;
        updateStatus('auth', 'success', mensaje);
        addLog('‚úÖ Test de autenticaci√≥n exitoso', 'success');
        return true;
      } catch (error) {
        updateStatus('auth', 'error', `‚ùå Error: ${error.message}`);
        addLog(`‚ùå Error en test de autenticaci√≥n: ${error.message}`, 'error');
        return false;
      }
    }

    async function testPermissions() {
      addLog('üëë Iniciando test de permisos...', 'info');
      
      try {
        const usuario = auth.obtenerUsuarioActual();
        
        if (!usuario) {
          updateStatus('permissions', 'error', '‚ùå Debes estar autenticado primero');
          addLog('‚ùå Test de permisos fallido: No hay sesi√≥n activa', 'error');
          return false;
        }

        const tienePermiso = await roles.tienePermiso(usuario.id, 'crear_anuncios');
        
        if (!tienePermiso) {
          updateStatus('permissions', 'error', '‚ùå El usuario no tiene permiso para crear anuncios');
          addLog('‚ùå Test de permisos fallido: Sin permiso crear_anuncios', 'error');
          return false;
        }

        updateStatus('permissions', 'success', '‚úÖ El usuario tiene permisos para crear anuncios');
        addLog('‚úÖ Test de permisos exitoso', 'success');
        return true;
      } catch (error) {
        updateStatus('permissions', 'error', `‚ùå Error: ${error.message}`);
        addLog(`‚ùå Error en test de permisos: ${error.message}`, 'error');
        return false;
      }
    }

    function testValidations() {
      addLog('‚úÖ Iniciando test de validaciones...', 'info');
      
      const tests = [
        { name: 'T√≠tulo vac√≠o', valid: false },
        { name: 'Contenido vac√≠o', valid: false },
        { name: 'Tipo no seleccionado', valid: false },
        { name: 'Archivo muy grande (>10MB)', valid: false },
        { name: 'Formato no soportado', valid: false },
        { name: 'Datos completos y v√°lidos', valid: true }
      ];

      let results = tests.map(test => 
        `${test.valid ? '‚úÖ' : '‚ùå'} ${test.name}: ${test.valid ? 'Debe permitir' : 'Debe rechazar'}`
      ).join('\n');

      updateStatus('validation', 'success', results);
      addLog('‚úÖ Test de validaciones completado', 'success');
    }

    async function testCreateAnnouncement() {
      addLog('üì¢ Iniciando test de creaci√≥n de anuncio...', 'info');
      
      try {
        const usuario = auth.obtenerUsuarioActual();
        
        if (!usuario) {
          updateStatus('create', 'error', '‚ùå Debes estar autenticado primero');
          addLog('‚ùå Test de creaci√≥n fallido: No hay sesi√≥n activa', 'error');
          return false;
        }

        const anuncioTest = {
          titulo: `Test Anuncio - ${new Date().toLocaleString()}`,
          contenido: 'Este es un anuncio de prueba creado por el sistema de testing. Puede ser eliminado.',
          tipo: 'info',
          destacado: false
        };

        addLog('üì§ Enviando anuncio de prueba a Firebase...', 'info');
        
        const result = await roles.crearAnuncio(anuncioTest);
        
        if (result.success) {
          const mensaje = `‚úÖ Anuncio creado exitosamente\nID: ${result.id}\nT√≠tulo: ${anuncioTest.titulo}`;
          updateStatus('create', 'success', mensaje);
          addLog(`‚úÖ Anuncio creado con ID: ${result.id}`, 'success');
          return true;
        } else {
          updateStatus('create', 'error', `‚ùå Error: ${result.error}`);
          addLog(`‚ùå Error al crear anuncio: ${result.error}`, 'error');
          return false;
        }
      } catch (error) {
        updateStatus('create', 'error', `‚ùå Error: ${error.message}`);
        addLog(`‚ùå Error en test de creaci√≥n: ${error.message}`, 'error');
        return false;
      }
    }

    async function cleanupTestAnnouncements() {
      addLog('üßπ Limpiando anuncios de prueba...', 'info');
      
      try {
        const response = await fetch('https://laburitoya-6e55d-default-rtdb.firebaseio.com/anuncios.json');
        const data = await response.json();
        
        if (!data) {
          addLog('‚ÑπÔ∏è No hay anuncios para limpiar', 'info');
          alert('No hay anuncios de prueba para eliminar');
          return;
        }

        let deleted = 0;
        for (const [id, anuncio] of Object.entries(data)) {
          if (anuncio.titulo && anuncio.titulo.startsWith('Test Anuncio')) {
            await fetch(`https://laburitoya-6e55d-default-rtdb.firebaseio.com/anuncios/${id}.json`, {
              method: 'DELETE'
            });
            deleted++;
            addLog(`üóëÔ∏è Eliminado: ${anuncio.titulo}`, 'info');
          }
        }

        addLog(`‚úÖ Limpieza completada: ${deleted} anuncios eliminados`, 'success');
        alert(`Se eliminaron ${deleted} anuncios de prueba`);
      } catch (error) {
        addLog(`‚ùå Error en limpieza: ${error.message}`, 'error');
        alert('Error al limpiar anuncios: ' + error.message);
      }
    }

    async function runAllTests() {
      addLog('üöÄ Ejecutando todos los tests...', 'info');
      
      const authOk = await testAuth();
      if (!authOk) {
        addLog('‚ö†Ô∏è Tests detenidos: Fallo en autenticaci√≥n', 'error');
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 500));
      
      const permOk = await testPermissions();
      if (!permOk) {
        addLog('‚ö†Ô∏è Tests detenidos: Fallo en permisos', 'error');
        return;
      }

      await new Promise(resolve => setTimeout(resolve, 500));
      testValidations();

      await new Promise(resolve => setTimeout(resolve, 500));
      await testCreateAnnouncement();

      addLog('üéâ Todos los tests completados', 'success');
    }

    // Inicializaci√≥n
    window.addEventListener('DOMContentLoaded', () => {
      addLog('‚úÖ Sistema de testing cargado', 'success');
      addLog('‚ÑπÔ∏è Haz clic en los botones para ejecutar los tests', 'info');
    });
  </script>
</body>
</html>
